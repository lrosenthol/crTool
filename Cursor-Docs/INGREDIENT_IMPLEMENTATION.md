# Ingredient Support Implementation Summary

## Overview

This document summarizes the implementation of file-based ingredient support for the c2pa-testfile-maker tool.

## Implementation Details

### 1. Core Features Added

#### Command-Line Options
- `--ingredients-dir <DIR>`: Specify base directory for resolving ingredient file paths (defaults to manifest directory)
- `--thumbnail-asset`: Generate thumbnail for the main asset (opt-in, default: false)
- `--thumbnail-ingredients`: Generate thumbnails for ingredients (opt-in, default: false)

#### Manifest JSON Format
A new `ingredients_from_files` field allows specifying ingredients to load from files:

```json
{
  "ingredients_from_files": [
    {
      "title": "Background Image",
      "relationship": "parentOf",
      "file_path": "../testfiles/Dog.jpg"
    },
    {
      "title": "Logo Overlay",
      "relationship": "componentOf",
      "file_path": "../assets/logo.png"
    }
  ]
}
```

### 2. Key Design Decisions

#### Separation from Standard Ingredients
- Used `ingredients_from_files` instead of `ingredients` to avoid conflicts with Builder's JSON parsing
- This allows mixing file-based and inline ingredient definitions if needed
- Clear separation of concerns between manifest metadata and file loading

#### Opt-In Thumbnail Generation
- Thumbnails are NOT generated by default (per user requirement)
- Separate flags for asset and ingredient thumbnails provide fine-grained control
- Thumbnails are 256x256 JPEG images when generated

#### Path Resolution
- Relative paths are resolved relative to the manifest file's directory
- Can override with `--ingredients-dir` for custom base directory
- Absolute paths are supported and used as-is

### 3. Code Architecture

#### Main Components

1. **`extension_to_mime()`**: Converts file extensions to MIME types
2. **`make_thumbnail_from_stream()`**: Generates 256x256 JPEG thumbnails from image files
3. **`process_ingredients()`**: Main ingredient processing function that:
   - Parses the manifest JSON for `ingredients_from_files`
   - Resolves file paths
   - Loads ingredient files
   - Creates Ingredient objects with proper metadata
   - Optionally generates thumbnails
   - Adds ingredients to the Builder

#### Integration Points
- Added to `main()` function after Builder creation
- Works alongside existing manifest processing
- Test helpers in `tests/common/mod.rs` mirror the functionality

### 4. Testing

#### Test Coverage
- **test_simple_with_ingredient**: Single ingredient loading
- **test_with_ingredients_from_files**: Multiple ingredients with different relationships
- **test_ingredient_thumbnails_generated**: Ingredient loading verification
- **test_ingredient_missing_file_error**: Error handling for missing files

All 39 tests pass, including the 4 new ingredient-specific tests.

### 5. Dependencies Added

- `image` crate (v0.25) for thumbnail generation
- Features enabled: jpeg, png, gif, bmp, tiff, webp

## Usage Examples

### Basic Usage with Ingredients
```bash
c2pa-testfile-maker \
  --manifest examples/simple_with_ingredient.json \
  --input output.jpg \
  --output signed.jpg \
  --cert cert.pem \
  --key key.pem
```

### With Thumbnails
```bash
c2pa-testfile-maker \
  --manifest examples/with_ingredients_from_files.json \
  --input output.jpg \
  --output signed.jpg \
  --cert cert.pem \
  --key key.pem \
  --thumbnail-asset \
  --thumbnail-ingredients
```

### Custom Ingredient Directory
```bash
c2pa-testfile-maker \
  --manifest manifest.json \
  --input output.jpg \
  --output signed.jpg \
  --cert cert.pem \
  --key key.pem \
  --ingredients-dir /path/to/source/files
```

## Files Modified

1. **src/main.rs**: Core implementation
   - Added CLI flags
   - Implemented ingredient processing
   - Thumbnail generation functions

2. **Cargo.toml**: Added `image` dependency

3. **tests/common/mod.rs**: Test helper functions
   - `sign_file_with_manifest_and_ingredients()`
   - `process_ingredients()` for testing

4. **tests/integration_tests.rs**: New test cases

5. **README.md**: Comprehensive documentation
   - Feature description
   - Usage examples
   - Manifest format documentation

6. **examples/**: New example manifests
   - `simple_with_ingredient.json`
   - `with_ingredients_from_files.json`

## Benefits

1. **Flexible**: Supports both relative and absolute paths
2. **Controlled**: Opt-in thumbnail generation
3. **Maintainable**: Clean separation of concerns
4. **Well-tested**: Comprehensive test coverage
5. **Documented**: Clear examples and usage guidelines

## Future Enhancements

Potential areas for future improvement:
- Support for remote ingredient URLs
- Batch ingredient processing from a directory
- Custom thumbnail sizes
- Video/audio ingredient support
- Ingredient validation and pre-flight checks
